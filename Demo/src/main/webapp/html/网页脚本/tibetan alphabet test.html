<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>藏文打字速度测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        #text-display {
            font-size: 24px;
            margin: 20px;
            line-height: 1.5;
            min-height: 100px;
        }
        #input-field {
            width: 80%;
            height: 100px;
            font-size: 20px;
            margin: 20px;
            padding: 10px;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        #stats {
            margin: 20px;
            font-size: 18px;
        }
        .button-container {
            display: flex;
            gap: 10px;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #save-btn {
            display: none;
        }
        .statistics-tables {
            display: flex;
            gap: 20px;
            margin: 20px;
            width: 100%;
            justify-content: center;
        }
        .stat-table {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            min-width: 300px;
        }
        .stat-table h3 {
            margin-top: 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>藏文打字速度测试</h1>
    <div id="stats">
        <p>时间: <span id="timer">0</span> 秒</p>
        <p>速度: <span id="wpm">0</span> 字/分钟</p>
        <p>正确率: <span id="accuracy">0</span>%</p>
        <p>错误率: <span id="error-rate">0</span>%</p>
    </div>
    <div id="text-display"></div>
    <textarea id="input-field" placeholder="在此输入藏文..." disabled></textarea>
    <div class="button-container">
        <button id="start-btn">开始测试</button>
        <button id="save-btn">保存结果</button>
    </div>
    <div class="statistics-tables">
        <div class="stat-table">
            <h3>错误统计表</h3>
            <table id="error-table">
                <thead>
                    <tr>
                        <th>正确字符</th>
                        <th>错误输入</th>
                        <th>错误次数</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="stat-table">
            <h3>正确字符频率统计</h3>
            <table id="frequency-table">
                <thead>
                    <tr>
                        <th>字符</th>
                        <th>出现次数</th>
                        <th>频率</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const sampleText = "བོད་ཡིག་ནི་བོད་རིགས་ཀྱི་སྐད་ཡིག་ཡིན། བོད་ཡིག་ནི་དབྱངས་གསལ་གྱི་ཡི་གེ་ཞིག་ཡིན།"; // 示例藏文文本
        let startTime, timer;
        let isTestActive = false;
        let totalCharacters = 0;
        let correctCharacters = 0;
        let testResults = null;
        let errorStats = {};
        let frequencyStats = {};

        const textDisplay = document.getElementById('text-display');
        const inputField = document.getElementById('input-field');
        const startButton = document.getElementById('start-btn');
        const saveButton = document.getElementById('save-btn');
        const timerDisplay = document.getElementById('timer');
        const wpmDisplay = document.getElementById('wpm');
        const accuracyDisplay = document.getElementById('accuracy');
        const errorRateDisplay = document.getElementById('error-rate');
        const errorTableBody = document.querySelector('#error-table tbody');
        const frequencyTableBody = document.querySelector('#frequency-table tbody');

        function initializeTest() {
            textDisplay.innerHTML = sampleText.split('').map(char => 
                `<span class="char">${char}</span>`).join('');
            inputField.value = '';
            totalCharacters = 0;
            correctCharacters = 0;
            errorStats = {};
            frequencyStats = {};
            startTime = new Date();
            isTestActive = true;
            inputField.disabled = false;
            inputField.focus();
            saveButton.style.display = 'none';
            errorTableBody.innerHTML = '';
            frequencyTableBody.innerHTML = '';

            timer = setInterval(() => {
                const currentTime = Math.floor((new Date() - startTime) / 1000);
                timerDisplay.textContent = currentTime;
                
                const minutes = currentTime / 60;
                const wpm = Math.round(totalCharacters / minutes);
                wpmDisplay.textContent = wpm;
            }, 1000);
        }

        function updateErrorStats(correctChar, inputChar) {
            if (!errorStats[correctChar]) {
                errorStats[correctChar] = {};
            }
            if (!errorStats[correctChar][inputChar]) {
                errorStats[correctChar][inputChar] = 0;
            }
            errorStats[correctChar][inputChar]++;
        }

        function updateFrequencyStats(char) {
            if (!frequencyStats[char]) {
                frequencyStats[char] = 1;
            } else {
                frequencyStats[char]++;
            }
        }

        function displayErrorStats() {
            errorTableBody.innerHTML = '';
            for (const [correctChar, errors] of Object.entries(errorStats)) {
                for (const [inputChar, count] of Object.entries(errors)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${correctChar}</td>
                        <td>${inputChar}</td>
                        <td>${count}</td>
                    `;
                    errorTableBody.appendChild(row);
                }
            }
        }

        function displayFrequencyStats() {
            frequencyTableBody.innerHTML = '';
            const totalChars = Object.values(frequencyStats).reduce((a, b) => a + b, 0);
            
            const sortedChars = Object.entries(frequencyStats)
                .sort((a, b) => b[1] - a[1]);

            for (const [char, count] of sortedChars) {
                const frequency = ((count / totalChars) * 100).toFixed(2);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${char}</td>
                    <td>${count}</td>
                    <td>${frequency}%</td>
                `;
                frequencyTableBody.appendChild(row);
            }
        }

        inputField.addEventListener('input', (e) => {
            if (!isTestActive) return;

            const inputText = e.target.value;
            totalCharacters = inputText.length;
            correctCharacters = 0;

            const characters = textDisplay.getElementsByClassName('char');
            
            for (let i = 0; i < characters.length; i++) {
                if (i < inputText.length) {
                    if (inputText[i] === sampleText[i]) {
                        characters[i].className = 'char correct';
                        correctCharacters++;
                        updateFrequencyStats(sampleText[i]);
                    } else {
                        characters[i].className = 'char incorrect';
                        updateErrorStats(sampleText[i], inputText[i]);
                    }
                } else {
                    characters[i].className = 'char';
                }
            }

            const accuracy = Math.round((correctCharacters / totalCharacters) * 100) || 0;
            const errorRate = 100 - accuracy;
            
            accuracyDisplay.textContent = accuracy;
            errorRateDisplay.textContent = errorRate;

            if (inputText.length === sampleText.length) {
                endTest();
            }
        });

        startButton.addEventListener('click', () => {
            if (isTestActive) {
                endTest();
            }
            initializeTest();
        });

        function endTest() {
            clearInterval(timer);
            isTestActive = false;
            inputField.disabled = true;
            startButton.textContent = '重新开始';
            saveButton.style.display = 'block';
            
            testResults = {
                time: timerDisplay.textContent,
                wpm: wpmDisplay.textContent,
                accuracy: accuracyDisplay.textContent,
                errorRate: errorRateDisplay.textContent,
                date: new Date().toLocaleString(),
                errorStats: errorStats,
                frequencyStats: frequencyStats
            };

            displayErrorStats();
            displayFrequencyStats();
        }

        saveButton.addEventListener('click', () => {
            if (!testResults) return;

            // 创建表格格式的错误统计
            let errorStatsText = '\n错误统计表:\n';
            errorStatsText += '┌──────────┬──────────┬──────────┐\n';
            errorStatsText += '│ 正确字符 │ 错误输入 │ 错误次数 │\n';
            errorStatsText += '├──────────┼──────────┼──────────┤\n';
            
            for (const [correctChar, errors] of Object.entries(testResults.errorStats)) {
                for (const [inputChar, count] of Object.entries(errors)) {
                    errorStatsText += `│ ${correctChar.padEnd(8)} │ ${inputChar.padEnd(8)} │ ${count.toString().padEnd(8)} │\n`;
                }
            }
            errorStatsText += '└──────────┴──────────┴──────────┘\n';

            // 创建表格格式的频率统计
            let frequencyStatsText = '\n字符频率统计表:\n';
            frequencyStatsText += '┌──────────┬──────────┬──────────┐\n';
            frequencyStatsText += '│   字符   │ 出现次数 │   频率   │\n';
            frequencyStatsText += '├──────────┼──────────┼──────────┤\n';
            
            const totalChars = Object.values(testResults.frequencyStats).reduce((a, b) => a + b, 0);
            const sortedChars = Object.entries(testResults.frequencyStats)
                .sort((a, b) => b[1] - a[1]);
            
            for (const [char, count] of sortedChars) {
                const frequency = ((count / totalChars) * 100).toFixed(2);
                frequencyStatsText += `│ ${char.padEnd(8)} │ ${count.toString().padEnd(8)} │ ${frequency.padEnd(6)}% │\n`;
            }
            frequencyStatsText += '└──────────┴──────────┴──────────┘\n';

            const content = `藏文打字测试结果
测试时间: ${testResults.date}
用时: ${testResults.time}秒
速度: ${testResults.wpm}字/分钟
正确率: ${testResults.accuracy}%
错误率: ${testResults.errorRate}%${errorStatsText}${frequencyStatsText}`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `藏文打字测试结果_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
